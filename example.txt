from flask import Flask, render_template, request, redirect, url_for, session
from datetime import datetime
import uuid
import json
import os

DATA_FILE = os.path.join("data", "data.json")

app = Flask(__name__, template_folder="views")
app.secret_key = "supersecretkey"  # Needed for session

ADMIN_PASSWORD = "splash123"  # You can change this

bookings = []
spot_status = {
    "A": {
        "is_occupied": False,
        "current_booking_id": None,
        "last_updated": datetime.utcnow().isoformat(),
    },
    "B": {
        "is_occupied": False,
        "current_booking_id": None,
        "last_updated": datetime.utcnow().isoformat(),
    },
}

def format_rupiah(nominal):
    return f"Rp {nominal:,.0f}".replace(",", ".") + ",-"

@app.route("/")
def home():
    return render_template("index.html")


# Admin login page
@app.route("/admin", methods=["GET", "POST"])
def admin_login():
    if request.method == "POST":
        password = request.form["password"]
        if password == ADMIN_PASSWORD:
            session["admin"] = True
            return redirect(url_for("admin_dashboard"))
        else:
            return render_template("admin_login.html", error="Password salah")
    return render_template("admin_login.html")


# Admin dashboard
@app.route("/admin/dashboard")
def admin_dashboard():
    if not session.get("admin"):
        return redirect(url_for("admin_login"))
    return render_template("admin_dashboard.html", spot_status=spot_status)


# Reset spot status
@app.route("/admin/reset/<spot_id>", methods=["POST"])
def reset_spot(spot_id):
    if not session.get("admin"):
        return redirect(url_for("admin_login"))
    spot_status[spot_id] = {
        "is_occupied": False,
        "current_booking_id": None,
        "last_updated": datetime.utcnow().isoformat(),
    }
    return redirect(url_for("admin_dashboard"))


@app.route("/admin/tables")
# bisa juga dengan args : /admin/tables?date=02-02-2026
def admin_tables():
    with open(DATA_FILE, "r") as f:
        data = json.load(f)

    # Pick date from query string, fallback to first key
    date_key = request.args.get("date") or list(data.keys())[0]
    bookings = data.get(date_key, [])

    # Count of bookings
    total_sales = len(bookings)

    # Sum of nominal values (make sure each booking has "nominal" as int)
    total_nominal = sum(b.get("nominal", 0) for b in bookings)

    # Format into Rupiah string
    def format_rupiah(nominal):
        return f"Rp {nominal:,.0f}".replace(",", ".") + ",-"

    total_nominal_format = format_rupiah(total_nominal)

    return render_template(
        "admin_tables.html",
        bookings=bookings,
        date_key=date_key,
        total_sales=total_sales,
        total_nominal=total_nominal_format
    )


# Logout
@app.route("/admin/logout")
def admin_logout():
    session.pop("admin", None)
    return redirect(url_for("admin_login"))


@app.route("/payment", methods=["POST"])
def payment():
    spot_id = request.form["spot_id"]

    if spot_status[spot_id]["is_occupied"]:
        return "Spot is currently occupied", 400

    name = request.form["name"]
    phone = request.form["phone"]
    service_type = request.form["service_type"]
    nominal = 50000 if(service_type=="Basic Wash") else 150000
    spot_id = request.form["spot_id"]
    return render_template(
        "payment_select.html",
        name=name,
        phone=phone,
        service_type=service_type,
        nominal=nominal,
        spot_id=spot_id,
    )


@app.route("/confirm", methods=["POST"])
def confirm_payment():
    name = request.form["name"]
    phone = request.form["phone"]
    service_type = request.form["service_type"]
    nominal = 50000 if (service_type == "Basic Wash") else 150000
    payment_method = request.form["payment_method"]
    spot_id = request.form["spot_id"]
    return render_template(
        "payment.html",
        name=name,
        phone=phone,
        service_type=service_type,
        payment_method=payment_method,
        nominal=nominal,
        spot_id=spot_id,
    )


@app.route("/complete", methods=["POST"])
def complete_booking():
    spot_id = request.form["spot_id"]
    if spot_status[spot_id]["is_occupied"]:
        return f"Spot {spot_id} is currently occupied", 400

    booking = {
        "id": str(uuid.uuid4()),
        "name": request.form["name"],
        "phone": request.form["phone"],
        "service_type": request.form["service_type"],
        "spot_id": spot_id,
        "nominal": int(request.form["nominal"]),
        "nominal_format": format_rupiah(int(request.form["nominal"])),
        "payment_method": request.form["payment_method"],
        "status": "paid",
        "created_at": datetime.utcnow().isoformat(),
    }

    # Update in-memory structures
    bookings.append(booking)
    spot_status[spot_id] = {
        "is_occupied": True,
        "current_booking_id": booking["id"],
        "last_updated": datetime.utcnow().isoformat(),
        "details": booking,
    }

    # grouped by date
    today = datetime.utcnow().strftime("%d-%m-%Y")  # e.g. "02-02-2026"

    # Load existing data.json
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r") as f:
            data = json.load(f)
    else:
        data = {}

    # Ensure today's key exists
    if today not in data:
        data[today] = []

    # Append booking
    data[today].append(booking)

    # Save back to file
    with open(DATA_FILE, "w") as f:
        json.dump(data, f, indent=4)

    return redirect(url_for("success", name=booking["name"]))


@app.route("/success")
def success():
    name = request.args.get("name", "Pelanggan")
    return render_template("success.html", name=name)


if __name__ == "__main__":
    app.run(debug=True)
